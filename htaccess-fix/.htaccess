# Forzar HTTPS en todo este directorio
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Evitar listar directorios
Options -Indexes

# Bloquear acceso directo a src/ y lib/
RedirectMatch 403 ^/api-mail/src/
RedirectMatch 403 ^/api-mail/lib/

# Solo permitir POST a send-email.php
<Files "send-email.php">
  <LimitExcept POST>
    Require all denied
  </LimitExcept>
</Files>

# ðŸ†• EVITAR CACHE DE WORDPRESS/NGINX EN API DE EMAIL
<IfModule mod_headers.c>
  # Evitar cache para send-email.php
  <Files "send-email.php">
    Header always set Cache-Control "no-cache, no-store, must-revalidate, private"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
    Header always unset ETag
    Header always set X-Cache-Control "BYPASS"
    Header always set X-No-Cache "1"
  </Files>
</IfModule>

# Evitar cache con variables de entorno
<Files "send-email.php">
  SetEnv no-cache 1
  SetEnv no-gzip 1
  SetEnv CACHE_BYPASS 1
</Files>

# Bypass especÃ­fico para Endurance Cache y WordPress Cache
<IfModule mod_rewrite.c>
  # Bypass cache para send-email.php
  RewriteCond %{REQUEST_URI} send-email\.php$
  RewriteRule .* - [E=Cache-Control:no-cache,E=no-gzip:1]
  
  # Alternative bypass para diferentes configuraciones
  RewriteCond %{REQUEST_URI} ^/api-mail/public/send-email\.php$
  RewriteRule .* - [E=CACHE_BYPASS:1,E=no-cache:1]
</IfModule>

# Para W3 Total Cache (si estÃ¡ instalado)
<IfModule mod_rewrite.c>
  RewriteCond %{REQUEST_URI} send-email\.php$
  RewriteRule .* - [E=W3TC_SKIP_CACHE:1]
</IfModule>

# Para WP Rocket (si estÃ¡ instalado)
<Files "send-email.php">
  SetEnv DONOTCACHEPAGE 1
</Files>

# Headers adicionales para asegurar no-cache
<IfModule mod_headers.c>
  <Files "send-email.php">
    Header always set X-Robots-Tag "noindex, nofollow, nosnippet, noarchive"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
  </Files>
</IfModule>
